<!-- tldr ::: waymark specification - simple, greppable breadcrumbs for code -->

# Waymark Specification v2.0

The canonical specification for **waymark syntax** — a lightweight breadcrumb protocol for codebases.

Waymarks are structured comments that provide developers and AI agents with searchable, context-rich markers throughout code. They are minimal, durable, and designed for both human readability and machine parsing.

---

## Why Waymarks

The v2.0 rewrite stands on decades of comment-level anchor practice: TODOs in Unix shells, `MARK:` blocks in editors, build flags in Go, suppression comments in lint tools, and ownership conventions from Google-style TODOs. Teams already rely on those breadcrumbs because they are easy to grep and safe to automate; we package the proven ideas into one predictable shape that modern tooling (and agents) can understand. See [Historical Priors for Waymark-Style Anchors](docs/about/priors.md) for the longer lineage that informed this spec.

Waymarks aim to:

- Preserve the greppability of single-line TODOs while standardizing vocabulary and structure
- Encode context, ownership, and intent directly in comments so agents do not need AST access
- Replace scattered bespoke conventions with one durable, language-agnostic pattern

The rest of this document describes the exact grammar and runtime expectations for those goals.

---

## 1. Core Principles

- **Always comments**: Waymarks exist only in comment syntax, never as content
- **Grep-first**: Every waymark is findable with simple text search
- **Gradually adoptable**: Coexist peacefully with existing comment patterns
- **AI-native**: Structured for human-AI collaboration
- **Language agnostic**: Work in any language that supports comments

---

## 2. Basic Structure

```
[comment-leader] [signal][marker] ::: [content]
```

### The `:::` Sigil

- Always three colons
- Exactly one space before (when marker present)
- Exactly one space after
- Marks the boundary between marker and content

```javascript
// todo ::: implement authentication
// ::: this is a pure note (no marker)
```

### Markers

Single, lowercase words describing purpose. One marker per waymark.

```javascript
// todo ::: add validation
// fix ::: memory leak in handler
// note ::: assumes UTC timezone
```

### Signals

Optional prefixes for urgency and scope:

- `*` - Current/active work (should not appear in main branch)
- `!` - Important/high priority
- Order: `*` before `!` when combined

```javascript
// *todo ::: finish before merging this PR
// !fix ::: critical security issue
// *!todo ::: urgent work for this branch
```

---

## 3. Content Structure

After the `:::` sigil, content can include:

### Properties

Simple `key:value` pairs for structured metadata.

```javascript
// todo ::: implement OAuth owner:@alice
// fix ::: race condition since:2.0.0
```

### Wikilinks

References enclosed in `[[...]]` for linking to resources.

```javascript
// note ::: see design [[auth-flow-design]]
// fix ::: bug in parser [[file:src/parser.ts#L42]]
// todo ::: refactor this [[symbol:AuthHandler::validate]]
```

Supported patterns:

- `[[free-form-reference]]` - Simple reference, tool-interpreted
- `[[file:path/to/file]]` - File reference (with optional line numbers)
- `[[symbol:Class::method]]` - Language symbol reference (future)
- `[[https://example.com]]` - Any wikilink containing `://` is treated as URL/URI

### Mentions

User/entity references with `@` prefix.

```javascript
// todo ::: @alice please review
// wip ::: @bob implementing core logic
// context ::: @agent validate all inputs
```

### Hashtags

Tags with `#` prefix for classification or referencing canonical refs.

```javascript
// todo ::: add caching #performance #backend
// fix ::: XSS vulnerability #security
// note ::: see auth implementation #auth/core  // references a canonical ref
```

Hashtags serve dual purposes:

- **Simple tags**: Free-form classification (`#performance`, `#security`)
- **Canonical references**: Point to canonical ref declarations (`#auth/core` → `ref:#auth/core`)

---

## 4. Canonical Refs & References

Waymarks can establish durable reference points using the canonical ref system:

### Canonical Refs

Declare authoritative reference points with `ref:#token`:

```javascript
// tldr ::: authentication service ref:#auth/core
// this ::: payment processing module ref:#payments/processor
```

- **Canonical**: The `ref:#token` declares the authoritative location for that token
- **Unique**: Each token should have only one canonical ref declaration (repo-wide or file-scoped)
- **Namespaced**: Use `/` or `.` for organization (`#auth/core`, `#payments.stripe`)

### References

Reference canonical refs anywhere using bare hashtags or relation properties:

```javascript
// todo ::: refactor auth flow #auth/core
// fix ::: handle timeout depends:#payments/processor
// blocked ::: waiting for #auth/core redesign
```

The same `#token` that appears in `ref:#token` can be referenced throughout the codebase, creating navigable relationships.

## 5. Multi-line Waymarks

For content that exceeds comfortable line length:

```javascript
// todo ::: implement authentication flow
// ... with OAuth 2.0 and PKCE
// ... coordinate with security team :::
```

- Start continuation lines with `...`
- End with `:::` to mark closure
- Formatters may align `...` with opening `:::`

---

## 5. Core Vocabulary

### Blessed Markers

These markers are understood by waymark tooling and have defined semantics. Primary markers are listed first, with alternatives noted.

#### Work/Action Markers

- **`todo`** - Task to be completed
- **`fix`** - Bug or issue to resolve
  Alternatives: `fixme`
- **`wip`** - Work currently in progress
- **`done`** - Completed task
- **`review`** - Code or design needing review
- **`test`** - Test needed or test-related marker
- **`check`** - Validation or verification needed

#### Information Markers

- **`note`** - General annotation or comment
- **`context`** - Behavioral constraints or reasoning
  Alternatives: `why`
- **`tldr`** - File-level summary (see special rules below)
- **`this`** - Section or block-level summary
  Alternatives: `about`
- **`example`** - Usage example or demonstration
- **`idea`** - Future possibility or enhancement (not a commitment)

#### Caution/Quality Markers

- **`warn`** - Warning about code behavior or usage
- **`alert`** - Important notice requiring attention (more urgent than warn)
- **`deprecated`** - Scheduled for removal in future version
- **`temp`** - Temporary code to be removed
  Alternatives: `tmp`
- **`hack`** - Quick workaround or incomplete solution
  Alternatives: `stub`

#### Workflow Markers

- **`blocked`** - Work blocked by dependency or external factor
- **`needs`** - Dependency or requirement

#### Inquiry Markers

- **`question`** - Open question or requested clarification
  Alternatives: `ask`

### Special Marker Rules

#### The `tldr` Marker

Special marker that **must** appear at the topmost valid position in a file:

- After shebang, front matter, file headers
- Before any other content or waymarks
- One per file
- Provides file-level purpose/summary

```javascript
#!/usr/bin/env node
// tldr ::: authentication service with JWT support

// ... rest of file ...
```

#### The `this` Marker

Section-level summary marker for classes, functions, or code blocks:

- Placed at the beginning of the relevant section
- Multiple allowed per file
- Provides localized context

```javascript
class UserAuth {
  // this ::: handles user authentication lifecycle

  constructor() {
    // this ::: initializes auth providers
  }
}
```

### Blessed Properties

Core properties with semantic meaning:

#### Canonical Ref Properties

- `ref:#token` - Declares a canonical ref (authoritative reference point)

#### Relation Properties

- `depends:#token` - Dependency relationship to another ref
- `blocks:#token` - This blocks another ref/work item
- `needs:#token` - Requirement or prerequisite

#### Work Properties

- `owner:@person` - Responsible party
- `closes:#123` - Closes issue/PR

#### Lifecycle Properties

- `since:version` - Starting version/date
- `until:version` - Ending version/date

Teams can define custom properties as needed. Relation properties create navigable links between waymarks when paired with canonical refs.

---

## 6. What We're NOT Doing

To maintain simplicity and focus:

### Not Supported

- **Complex data structures**: No `(key:val, key:val)` or nested arrays
- **Priority properties**: No `priority:high` - use `!` signal instead
- **Question signals**: No `?` or `??` - use appropriate markers
- **Multiple signals**: No `--` or other complexity
- **Commit references**: No `[[^commit]]` - too fragile with git history
- **Embedded in docstrings**: Waymarks stay in line comments
- **Visible documentation**: Never rendered content, always comments
- **Case mixing**: Markers are lowercase or uppercase, not TitleCase
- **Backward compatibility**: Legacy waymarks (v1-era syntax) have no migration guarantees—they remain for historical context only and tooling may rewrite or ignore them

### Deliberately Simple

- No complex property syntax - just flat `key:value`
- No required properties beyond the blessed four
- No multi-level signal intensities (just `!`, not `!!`)
- No forced migration - old TODOs can coexist

---

## 7. Language Integration

Waymarks use native comment syntax for each language:

```python
# todo ::: add input validation
```

```rust
// fix ::: handle error case
```

```html
<!-- tldr ::: user profile template -->
```

```sql
-- note ::: this query assumes indexed columns
```

---

## 8. Search Patterns

### Basic ripgrep

```bash
# Find all waymarks
rg ":::"

# Find by marker
rg "todo :::"
rg "\\*todo :::"  # Current work

# Find by property
rg ":::.*owner:@alice"

# Find canonical refs
rg "ref:#auth/core"

# Find all references to a canonical ref
rg "#auth/core"

# Find dependencies
rg "depends:#"
rg "blocks:#"

# Find by hashtag
rg "#security"

# Multi-line waymarks
rg -U "todo :::.*\n.*\\.\\.\\..*:::"
```

### Waymark CLI

```bash
# Find with structured queries
waymark find todo --owner @alice

# Generate file map with tldrs
waymark map

# Interactive TUI
waymark

# JSON output for tools/agents
waymark find --json

# Include legacy TODOs
waymark find --include-legacy
```

---

## 9. AI Agent Collaboration

Waymarks enable human-AI workflow:

```javascript
// context ::: this function must be pure - no side effects
// todo ::: @agent add input validation for email format
// wip ::: @human implementing business logic
```

Agents can:

- Scan for mentions (`@agent`)
- Read context markers for constraints
- Leave waymarks as they work
- Generate tldr summaries

---

## 10. Migration & Adoption

### Gradual Adoption

- Waymarks coexist with existing `TODO:`, `FIXME:` patterns
- No forced conversion required
- CLI tool can optionally migrate old patterns
- Legacy waymarks are surfaced for historical context only; tooling may rewrite or ignore them when normalizing to v2

### Configuration

`.waymarkrc` for team preferences:

```yaml
# Marker case preference
marker_case: lowercase  # or uppercase

# Custom properties
custom_properties:
  - ticket
  - epic
  - component

# Default output format
default_format: pretty  # or json, simple
```

---

## 11. Tooling Responsibilities

The specification defines syntax only. Tooling may:

- Enforce marker case based on config
- Validate property syntax
- Strip `*` markers on merge to main
- Generate tldr maps
- Provide IDE integrations
- Index for performance

---

## 12. Examples

### Basic Usage

```javascript
// tldr ::: user authentication service ref:#auth/service

import jwt from 'jsonwebtoken';

class AuthService {
  // this ::: handles all authentication operations ref:#auth/core

  // todo ::: add rate limiting depends:#infra/ratelimit
  login(email, password) {
    // !fix ::: validate email format
    // context ::: must check against active users only

    // *wip ::: implementing JWT generation
    // ... need to add refresh token support
    // ... coordinate with frontend team :::

    const user = findUser(email);
    // note ::: user might be null [[file:src/db/users.ts#L45]]

    // check ::: verify token expiry handling
    return generateToken(user);
  }

  // deprecated ::: use login() instead since:3.0.0
  oldLogin() {
    // warn ::: this bypasses rate limiting #auth/core
    // hack ::: temporary fix until v4 ships
    return legacyAuth();
  }
}

// idea ::: consider OAuth integration for social logins blocks:#auth/oauth

### AI Collaboration

```typescript
// tldr ::: payment processing module ref:#payments/core

// context ::: @agent never log credit card numbers
// todo ::: @agent implement PCI compliance checks depends:#compliance/pci

export async function processPayment(data: PaymentData) {
  // this ::: processes payments through Stripe API ref:#payments/stripe

  // *review ::: @alice review security implications
  // fix ::: handle network timeouts closes:#456 needs:#infra/retry
  // alert ::: requires PCI compliance audit blocks:#payments/launch

  // note ::: uses Stripe API v3 [[https://stripe.com/docs]]
  // needs ::: error recovery strategy depends:#payments/retry-logic

  return await stripe.charges.create(data);
}

// example ::: processPayment({amount: 1000, currency: 'usd', source: token})
```

### Workflow Example

```javascript
// tldr ::: data migration utilities ref:#migration/v3

// blocked ::: waiting for database schema v3 blocks:#migration/deploy
export function migrateUserData() {
  // this ::: migrates user data from v2 to v3 schema ref:#migration/users

  // test ::: add integration tests for edge cases
  // question ::: should we batch process or stream? @dba-team

  // temp ::: using synchronous processing until we optimize
  const users = getAllUsers();

  // !warn ::: this locks the users table #migration/users
  return batchProcess(users);
}

// note ::: rollback procedure documented #migration/v3 [[file:docs/rollback.md]]

---

## Summary

Waymark v2.0 focuses on simplicity and pragmatism:

- **Structure**: `[signal][marker] ::: [content]`
- **Signals**: Just `*` (current) and `!` (important)
- **Canonical refs**: Optional `ref:#token` for durable reference points
- **Relations**: `depends:`, `blocks:`, `needs:` for explicit dependencies
- **Links**: Simple `[[...]]` wikilinks
- **Properties**: Flat `key:value` pairs
- **Always comments**: Never visible content
- **Grep-first**: Simple search always works
- **AI-ready**: Built for human-agent collaboration

The result is a breadcrumb system that's immediately useful, progressively enhanceable, and respectful of existing practices.
