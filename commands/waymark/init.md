---
description: Initialize waymarks in a project with guided setup
argument-hint: [--plan] [--execute]
allowed-tools: AskUserQuestion, Edit, Glob, Grep, Read, Task, Write, Bash(wm:*, rg:*, git:*, ls:*, head:*, wc:*, mkdir:*)
---

<!-- tldr ::: guided project initialization for waymark setup with strategy selection -->

# Initialize Waymarks Command

Initialize waymarks in the current project through guided setup.

## Arguments

- `--plan` - Skip questions, generate plan document only
- `--execute` - Skip questions, execute immediately with detected defaults

## Context Injection

Existing config: !`cat .waymark/config.jsonc 2>/dev/null || echo "Not configured"`
Source files: !`git ls-files '*.ts' '*.tsx' '*.js' '*.jsx' '*.py' '*.rs' '*.go' '*.rb' | head -20`

## Instructions

Load the `waymark-authoring` skill for grammar and marker guidance.

### Phase 1: Environment Detection

Before asking questions, gather context:

1. **Check existing waymark setup**:

   ```bash
   ls -la .waymark/ 2>/dev/null
   ```

2. **Detect agent configurations**:

   ```bash
   # Claude
   [ -f "CLAUDE.md" ] && echo "@claude"
   # Cursor
   [ -d ".cursor" ] && echo "@cursor"
   # Codex
   [ -f "codex.json" ] && echo "@codex"
   # Windsurf
   [ -d ".windsurf" ] && echo "@windsurf"
   ```

3. **Scan source file types**:

   ```bash
   git ls-files '*.ts' '*.tsx' '*.js' '*.jsx' '*.py' '*.rs' '*.go' '*.rb' | head -100
   ```

4. **Count files in scope**:

   ```bash
   git ls-files '*.ts' '*.tsx' '*.js' '*.jsx' '*.py' '*.rs' '*.go' '*.rb' | wc -l
   ```

Store detected agents and file count for later questions.

### Phase 2: Strategy Selection

Use AskUserQuestion to gather preferences:

**Q1: Strategy Tier**

```text
Question: "What level of waymark coverage do you want?"
Options:
- Minimal: TLDRs only - one summary per file
- Standard (Recommended): TLDRs + work markers (todo, fix, wip, done)
- Comprehensive: All markers including section markers (this, note, context)
```

**Q2: Agent Behavior** (only ask if Comprehensive selected)

```text
Question: "How should waymarks be added?"
Options:
- Execute now: Add all waymarks immediately via background agents
- TLDRs + report: Add TLDRs now, report other opportunities
- Plan document: Generate plan for review, defer execution
```

**Q3: File Patterns**

```text
Question: "Which files should be in scope?"
(Show detected patterns, allow customization)
Options:
- Detected defaults (Recommended): [show detected patterns]
- Customize: Let me specify include/exclude patterns
```

**Q4: Tag Namespaces**

```text
Question: "Which tag namespaces do you want to use?"
(Multi-select, suggest based on strategy)
Options:
- #docs - documentation
- #perf - performance
- #sec - security
- #arch - architecture
- #lib - library/utilities
- #test - testing
```

**Q5: Actor Conventions**

```text
Question: "How should agent mentions work?"
(Show detected agents)
Options:
- Use detected agents: [list detected, e.g., @claude, @cursor]
- Generic only: Just use @agent for all automation
- Custom: Let me specify actor groups
```

### Phase 3: Config Generation

Create `.waymark/` directory if needed:

```bash
mkdir -p .waymark
```

Write `.waymark/config.jsonc`:

```jsonc
{
  // Waymark configuration
  // Generated by /waymark:init on [date]

  "strategy": "[minimal|standard|comprehensive]",

  "markers": {
    "enabled": ["tldr", ...], // Based on strategy
    "custom": []
  },

  "files": {
    "include": ["src/**/*.ts", ...], // Detected patterns
    "exclude": ["**/*.test.ts", "**/*.d.ts", "**/node_modules/**"]
  },

  "tags": {
    "namespaces": ["docs", "perf", ...] // Selected namespaces
  },

  "actors": {
    "groups": {
      "@agents": ["@claude", "@cursor", "@agent"] // Detected + defaults
    },
    "default": "@agent"
  },

  "ids": {
    "mode": "auto",
    "length": 8
  }
}
```

### Phase 4: Execution

Based on selected mode:

#### Execute Mode (default for Minimal/Standard)

1. Spawn `waymarker` agents via Task tool with `run_in_background: true`
2. Partition files by top-level directory for parallelism
3. Each agent:
   - Reads files in its partition
   - Adds `tldr :::` waymarks to each file
   - For Standard+, also identifies and adds work markers
4. Report progress as agents complete

Example Task invocation:

```text
Task(
  subagent_type: "waymarker",
  prompt: "Add waymarks to files in src/auth/. Strategy: standard. Add tldr to each file, add todo/fix markers where obvious work items exist. Use IDs.",
  run_in_background: true
)
```

#### Plan Mode (option for Comprehensive)

1. Scan all files in scope
2. For each file:
   - Analyze content to draft TLDR suggestion
   - Identify sections that need `this :::` markers
   - Identify obvious work items for `todo :::` markers
3. Generate placeholder waymarks with IDs:

   ```ts
   // tldr ::: [pending] wm:init-a3k9
   ```

4. Write `.waymark/plan.md` with YAML blocks:

```markdown
# Waymark Initialization Plan

Generated: [timestamp]
Strategy: comprehensive

## Summary

- Files to annotate: [count]
- TLDRs to add: [count]
- Section markers suggested: [count]
- Work markers suggested: [count]

## Pending Waymarks

### [file path]

```yaml
- id: wm:init-xxxx
  line: 1
  type: tldr
  content: "[pending]"
  suggestion: "Suggested TLDR content here"
```

## Next Steps

Review suggestions above, then run `/waymark:apply` to apply them.
Edit this file to modify suggestions before applying.

```text

5. Instruct user to review and run `/waymark:apply`

### Phase 5: Summary

Report what was done:

**Execute Mode:**
```text

Waymark initialization complete!

Config: .waymark/config.jsonc
Strategy: standard
Files processed: 47
TLDRs added: 42
Work markers added: 15

Run `wm find .` to see all waymarks.
Run `/waymark:audit` to check coverage.

```

**Plan Mode:**

```text

Waymark initialization plan created!

Config: .waymark/config.jsonc
Plan: .waymark/plan.md
Strategy: comprehensive
Files analyzed: 47
Suggestions generated: 82

Review .waymark/plan.md and run `/waymark:apply` to apply suggestions.

```

## Strategy â†’ Markers Mapping

| Strategy      | Markers Enabled                                                               |
| ------------- | ----------------------------------------------------------------------------- |
| Minimal       | tldr                                                                          |
| Standard      | tldr, todo, fix, wip, done, review                                            |
| Comprehensive | tldr, todo, fix, wip, done, review, this, note, context, warn, hack, temp     |

## Error Handling

- If `.waymark/config.jsonc` exists, ask whether to overwrite or merge
- If git is not available, fall back to file system glob
- If no source files detected, warn and ask for manual patterns
- If agents fail, report partial progress and allow retry
