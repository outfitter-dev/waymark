---
description: Apply waymarks from a plan document
argument-hint: [--all] [--interactive]
allowed-tools: Bash(wm:*), Read, Write, Edit, Grep, Glob, AskUserQuestion
---

<!-- tldr ::: apply pending waymarks from plan document with interactive review -->

# Apply Waymarks Command

Apply pending waymarks from `.waymark/plan.md` generated by `/waymark:init`.

## Arguments

- `--all` - Apply all suggestions without prompting
- `--interactive` - Review each suggestion individually (default)

## Context Injection

Plan document: !`cat .waymark/plan.md 2>/dev/null | head -200`

## Instructions

Load the `using-waymarks` skill for grammar guidance.

### Phase 1: Load Plan

1. Read `.waymark/plan.md`
2. Parse YAML blocks to extract pending waymarks:
   - `id`: The waymark ID (e.g., `wm:init-a3k9`)
   - `line`: Target line number
   - `type`: Marker type (tldr, this, todo, etc.)
   - `content`: Current content (usually `[pending]`)
   - `suggestion`: Recommended content

3. If plan file missing, error:

   ```text
   No plan file found at .waymark/plan.md
   Run /waymark:init with plan mode first.
   ```

### Phase 2: Review Mode

#### Interactive Mode (default)

For each pending waymark:

1. Show context:

   ```text
   File: src/auth/service.ts
   Line: 1
   Type: tldr

   Suggested:
     // tldr ::: BetterAuth service handling session lifecycle and token refresh

   Current placeholder:
     // tldr ::: [pending] wm:init-a3k9
   ```

2. Ask user:

   ```text
   Question: "Apply this waymark?"
   Options:
   - Accept: Apply the suggestion as-is
   - Edit: Let me modify the suggestion
   - Skip: Leave placeholder, move to next
   - Stop: Finish applying, leave remaining as pending
   ```

3. If "Edit" selected:
   - Ask for modified content via AskUserQuestion
   - Apply the modified version

4. If "Accept" or edited:
   - Use Edit tool to replace placeholder with final content
   - Keep the ID in the waymark: `// tldr ::: <content> wm:init-a3k9`

5. Track progress:
   - Applied: [count]
   - Skipped: [count]
   - Remaining: [count]

#### Batch Mode (`--all`)

Apply all suggestions without prompting:

1. For each pending waymark in plan:
   - Read the file
   - Find the placeholder by ID
   - Replace with suggestion content (keeping ID)

2. Report summary when complete

### Phase 3: Update Plan Document

After applying:

1. Remove applied waymarks from `.waymark/plan.md`
2. Update summary counts
3. If all applied, add completion note:

   ```markdown
   ## Status

   All waymarks applied on [timestamp].
   This plan file can be deleted.
   ```

### Phase 4: Summary

Report results:

```text
Waymark application complete!

Applied: 35
Skipped: 5
Remaining: 12

Skipped waymarks remain as placeholders in source files.
Run /waymark:apply again to review remaining items.
Run /waymark:audit to verify coverage.
```

## Finding Placeholders

Placeholders are found by their ID property:

```bash
# Find all pending placeholders
rg '\[pending\].*wm:init-' --json

# Find specific ID
rg 'wm:init-a3k9'
```

## Editing Waymarks by ID

When applying, replace the entire waymark line:

Before:

```ts
// tldr ::: [pending] wm:init-a3k9
```

After:

```ts
// tldr ::: BetterAuth service handling session lifecycle and token refresh wm:init-a3k9
```

The ID is preserved for future reference and index tracking.

## Error Handling

- If placeholder not found at expected line, search by ID in file
- If file was deleted, skip and warn
- If ID appears multiple times (shouldn't happen), warn and skip
- On any error, log and continue with next waymark
